name: Build on Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  test:
    name: Run unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm test

  build-and-release:
    name: Build binaries & attach to Release
    needs: test
    runs-on: ubuntu-latest
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install tooling
        run: |
          npm i -g eas-cli@^12
          sudo apt-get update
          sudo apt-get install -y jq

      - name: EAS build (iOS Simulator then Android)
        run: |
          set -euo pipefail
          mkdir -p dist

          # iOS simulator (no Apple creds needed)
          IOS_JSON=$(mktemp)
          eas build --platform ios --profile ios-simulator --non-interactive --wait --json > "$IOS_JSON"
          IOS_ID=$(jq -r '.[0].id' "$IOS_JSON" || echo null)
          if [ "$IOS_ID" != "null" ] && [ -n "$IOS_ID" ]; then
            eas build:download -i "$IOS_ID" -o dist/volunteam-ios-simulator.tar.gz || true
          fi

          # Android APK (allow failure so submission still has iOS asset)
          AND_JSON=$(mktemp)
          if eas build --platform android --profile android-apk --non-interactive --wait --json > "$AND_JSON"; then
            AND_ID=$(jq -r '.[0].id' "$AND_JSON" || echo null)
            if [ "$AND_ID" != "null" ] && [ -n "$AND_ID" ]; then
              eas build:download -i "$AND_ID" -o dist/volunteam-android.apk || true
            fi
          else
            echo "::warning::Android build failed (likely credentials not set). Skipping APK for now."
          fi

      - name: Upload to the GitHub Release
        uses: softprops/action-gh-release@v2
        if: ${{ github.event_name == 'release' && github.event.action == 'published' }}
        with:
          files: |
            dist/*.apk
            dist/*.tar.gz
