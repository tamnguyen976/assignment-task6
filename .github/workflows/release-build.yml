name: Build on Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  test:
    name: Run unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm test

  build-and-release:
    name: Build binaries & attach to Release
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install tooling
        run: |
          npm i -g eas-cli@^12
          sudo apt-get update
          sudo apt-get install -y jq

      - name: EAS build (Android APK + iOS Simulator)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p dist

          # Android (wait for completion and capture build id)
          ANDROID_JSON=$(mktemp)
          eas build --platform android --profile android-apk --non-interactive --wait --json > "$ANDROID_JSON"
          ANDROID_ID=$(jq -r '.[0].id' "$ANDROID_JSON") || true
          [ "$ANDROID_ID" != "null" ] && eas build:download -i "$ANDROID_ID" -o dist/volunteam-android.apk || echo "No Android artifact."

          # iOS simulator (wait and download)
          IOS_JSON=$(mktemp)
          eas build --platform ios --profile ios-simulator --non-interactive --wait --json > "$IOS_JSON"
          IOS_ID=$(jq -r '.[0].id' "$IOS_JSON") || true
          [ "$IOS_ID" != "null" ] && eas build:download -i "$IOS_ID" -o dist/volunteam-ios-simulator.tar.gz || echo "No iOS artifact."

      - name: Upload to the GitHub Release
        uses: softprops/action-gh-release@v2
        if: ${{ github.event_name == 'release' && github.event.action == 'published' }}
        with:
          files: |
            dist/*.apk
            dist/*.tar.gz
